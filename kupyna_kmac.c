#include <string.h>
#include "kupyna_kmac.h"

static const uint8_t dpad[128] = {
    0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
};

static const uint8_t kpad32[32] = {
    0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
};

static const uint8_t kpad48[80] = {
    0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x80, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
};

static const uint8_t kpad64[64] = {
    0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
};

void kupyna256_kmac(const uint8_t* key, const uint8_t* data, size_t len, uint8_t* mac)
{
    struct kupyna256_kmac_ctx_t ctx;

    kupyna256_kmac_init(&ctx, key);
    kupyna256_kmac_update(&ctx, data, len);
    kupyna256_kmac_final(&ctx, mac);
}

void kupyna384_kmac(const uint8_t* key, const uint8_t* data, size_t len, uint8_t* mac)
{
    struct kupyna384_kmac_ctx_t ctx;

    kupyna384_kmac_init(&ctx, key);
    kupyna384_kmac_update(&ctx, data, len);
    kupyna384_kmac_final(&ctx, mac);
}

void kupyna512_kmac(const uint8_t* key, const uint8_t* data, size_t len, uint8_t* mac)
{
    struct kupyna512_kmac_ctx_t ctx;

    kupyna512_kmac_init(&ctx, key);
    kupyna512_kmac_update(&ctx, data, len);
    kupyna512_kmac_final(&ctx, mac);
}

void kupyna256_kmac_init(struct kupyna256_kmac_ctx_t* ctx, const uint8_t* key)
{
    kupyna256_init(&ctx->hctx);
    kupyna256_update(&ctx->hctx, key,    32);
    kupyna256_update(&ctx->hctx, kpad32, sizeof(kpad32));

    ctx->len = 0;
    for (size_t i=0; i<32; ++i) {
        ctx->ik[i] = ~key[i];
    }
}

void kupyna256_kmac_update(struct kupyna256_kmac_ctx_t* ctx, const uint8_t* data, size_t len)
{
    ctx->len += len;
    kupyna256_update(&ctx->hctx, data, len);
}

void kupyna256_kmac_final(struct kupyna256_kmac_ctx_t* ctx, uint8_t* mac)
{
    uint64_t n      = ctx->len;
    size_t pad_size = n < 52 ? (51 - n) : (63 - ((n - 52) % 64));

    n = n * 8;
    kupyna256_update(&ctx->hctx, dpad,         pad_size + 1);
    kupyna256_update(&ctx->hctx, (uint8_t*)&n, sizeof(n));
    kupyna256_update(&ctx->hctx, dpad + 16,    4);
    kupyna256_update(&ctx->hctx, ctx->ik,      sizeof(ctx->ik));
    kupyna256_final(&ctx->hctx, mac);
}

void kupyna384_kmac_init(struct kupyna384_kmac_ctx_t* ctx, const uint8_t* key)
{
    kupyna512_init(&ctx->hctx);
    kupyna512_update(&ctx->hctx, key,    48);
    kupyna512_update(&ctx->hctx, kpad48, sizeof(kpad48));

    ctx->len = 0;
    for (size_t i=0; i<48; ++i) {
        ctx->ik[i] = ~key[i];
    }
}

void kupyna384_kmac_update(struct kupyna384_kmac_ctx_t* ctx, const uint8_t* data, size_t len)
{
    ctx->len += len;
    kupyna512_update(&ctx->hctx, data, len);
}

void kupyna384_kmac_final(struct kupyna384_kmac_ctx_t* ctx, uint8_t* mac)
{
    uint64_t n      = ctx->len;
    size_t pad_size = n < 116 ? (115 - n) : (127 - ((n - 116) % 128));

    n = n * 8;
    kupyna512_update(&ctx->hctx, dpad,         pad_size + 1);
    kupyna512_update(&ctx->hctx, (uint8_t*)&n, sizeof(n));
    kupyna512_update(&ctx->hctx, dpad + 16,    4);
    kupyna512_update(&ctx->hctx, ctx->ik,      sizeof(ctx->ik));
    kupyna512_final2(&ctx->hctx, mac, 384);
}

void kupyna512_kmac_init(struct kupyna512_kmac_ctx_t* ctx, const uint8_t* key)
{
    kupyna512_init(&ctx->hctx);
    kupyna512_update(&ctx->hctx, key,    64);
    kupyna512_update(&ctx->hctx, kpad64, sizeof(kpad64));

    ctx->len = 0;
    for (size_t i=0; i<64; ++i) {
        ctx->ik[i] = ~key[i];
    }
}
void kupyna512_kmac_update(struct kupyna512_kmac_ctx_t* ctx, const uint8_t* data, size_t len)
{
    ctx->len += len;
    kupyna512_update(&ctx->hctx, data, len);
}

void kupyna512_kmac_final(struct kupyna512_kmac_ctx_t* ctx, uint8_t* mac)
{
    uint64_t n      = ctx->len;
    size_t pad_size = n < 116 ? (115 - n) : (127 - ((n - 116) % 128));

    n = n * 8;
    kupyna512_update(&ctx->hctx, dpad,         pad_size + 1);
    kupyna512_update(&ctx->hctx, (uint8_t*)&n, sizeof(n));
    kupyna512_update(&ctx->hctx, dpad + 16,    4);
    kupyna512_update(&ctx->hctx, ctx->ik,      sizeof(ctx->ik));
    kupyna512_final(&ctx->hctx, mac);
}
